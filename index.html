<html>
  <body>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet.groupedlayercontrol.css" />
    
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="js/leaflet.groupedlayercontrol.js"></script>
    
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    
    <!--<script type="text/javascript" src="js/underscore-min.js"></script>    -->
    
    <script type="text/javascript" src="data/convertcsv.json"></script>
    <script type="text/javascript" src="data/stratfunding.json"></script>
    
    <div id="map"></div>

    <style>
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
    



    <!-- Okay, time to do this! -->
    <script type="text/javascript">
      $(document).ready( function() {

        var map = L.map('map').setView([40, -104.25], 7);

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);



        
        //function that will reduce an array to unique values
    var arrayUnique = function(a) {
      return a.reduce(function(p, c) {
        if (p.indexOf(c) < 0) p.push(c);
        return p;
        }, []);
    };
      
        //list of all lgid's in main grants json file
        var lgidlist=[]; //array of strings
        var sumtotal=[]; //array of objects
        
        var i,j;  //iterators
        
        var b={}; //temp objects
        var gjson={};
        
        for(i=0;i<grants.length;i=i+1){
          if(grants[i].lgid){lgidlist.push(grants[i].lgid);}
        }
        
        //reduce to unique values only
        lgidlist = arrayUnique(lgidlist);
        
        //join to x, y, govname
        for(i=0;i<lgidlist.length;i=i+1){
          for(j=0;j<xy.length;j=j+1){
            if(lgidlist[i]==xy[j].LG_ID){
              var coordx=xy[j].X;
              var coordy=xy[j].Y;
              if(!coordx){coordx=0;coordy=0;}
              var geom={'type': 'Point', 'coordinates':[coordy, coordx]};
              var cdbg={'2011': 0, '2012': 0, '2013': 0, '2014':0};
              var csbg={'FFY2011-2012': 0, 'FFY2012-2013': 0, 'FFY2013-2014':0, 'FFY2014-2015':0, 'FFY2015-2016':0};
              var eiaf={'2011': 0, '2012': 0, '2013': 0, '2014':0, '2015':0};
              var ffb={'FFY2014-15': 0};
              var ctf={'FY2009-10': 0, 'FY2010-11': 0, 'FY2011-12': 0, 'FY2012-13':0, 'FY2013-14': 0, 'FY2014-15':0};
              var fmldd={'2009': 0, '2010': 0,'2011': 0, '2012': 0, '2013': 0, '2014':0};
              var fmlddsb106={'2014':0};              
              var game={'2010': 0, '2011': 0, '2012': 0, '2013': 0, '2014':0};
              var redi={'2014': 0, '2015': 0 };
              var sar={'FFY2009-10': 0, 'FFY2010-11': 0, 'FFY2011-12': 0, 'FFY2012-13': 0, 'FFY2013-14': 0};
              var sevedd={'FY2009': 0, 'FY2010': 0, 'FY2011': 0, 'FY2012': 0, 'FY2013': 0, 'FY2014': 0};
              var vfp={'FY2009-10':0, 'FY2010-11':0, 'FY2011-12':0, 'FY2012-13':0, 'FY2013-14':0, 'FY2014-15':0};
              b={'lgid': lgidlist[i], 'govname': xy[j].NAME, 'x': xy[j].X, 'y': xy[j].Y, 'total': 0, 'projects': [], 'CDBG':cdbg, 'CSBG':csbg, 'CTF':ctf, 'EIAF':eiaf, 'FFB':ffb, 'FMLDD':fmldd, 'FMLDDSB106': fmlddsb106, 'GAME': game, 'REDI': redi, 'SAR': sar, 'SEVEDD': sevedd, 'VFP': vfp };              
              gjson={'type': 'Feature', 'geometry': geom, 'properties': b};
              if(coordx){sumtotal.push(gjson);}else{
                //console.log(xy[j].LG_ID);
              } //remove
            }
          }
        }
        
        //loop through all projects.  add to sumtotal.  add to projects{}
         for(i=0;i<grants.length;i=i+1){
           for(j=0;j<sumtotal.length;j=j+1){
             if(grants[i].lgid===sumtotal[j].properties.lgid){
               if(grants[i].totalawarded){
                 
                 sumtotal[j].properties.total=sumtotal[j].properties.total+Number(grants[i].totalawarded); //if totalawarded exists, add it to lgidsumaward
                 
                 //mini sums for CDBG
                 if(grants[i].programtype==='CDBG'){
                   if(grants[i].yearofaward=='2011'){sumtotal[j].properties.CDBG['2011']=sumtotal[j].properties.CDBG['2011']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2012'){sumtotal[j].properties.CDBG['2012']=sumtotal[j].properties.CDBG['2012']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2013'){sumtotal[j].properties.CDBG['2013']=sumtotal[j].properties.CDBG['2013']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2014'){sumtotal[j].properties.CDBG['2014']=sumtotal[j].properties.CDBG['2014']+Number(grants[i].totalawarded)};                   
                 }
                 
                 //mini sums for CSBG
                 if(grants[i].programtype==='CSBG'){
                   if(grants[i].yearofaward=='FFY2011-2012'){sumtotal[j].properties.CSBG['FFY2011-2012']=sumtotal[j].properties.CSBG['FFY2011-2012']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FFY2012-2013'){sumtotal[j].properties.CSBG['FFY2012-2013']=sumtotal[j].properties.CSBG['FFY2012-2013']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FFY2013-2014'){sumtotal[j].properties.CSBG['FFY2013-2014']=sumtotal[j].properties.CSBG['FFY2013-2014']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FFY2014-2015'){sumtotal[j].properties.CSBG['FFY2014-2015']=sumtotal[j].properties.CSBG['FFY2014-2015']+Number(grants[i].totalawarded)};  
                   if(grants[i].yearofaward=='FFY2015-2016'){sumtotal[j].properties.CSBG['FFY2015-2016']=sumtotal[j].properties.CSBG['FFY2015-2016']+Number(grants[i].totalawarded)};
                 }
                 
                 
                 
                 //mini sums for CTF
                 if(grants[i].programtype==='CTF'){
                   if(grants[i].yearofaward=='FY2009-10'){sumtotal[j].properties.CTF['FY2009-10']=sumtotal[j].properties.CTF['FY2009-10']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2010-11'){sumtotal[j].properties.CTF['FY2010-11']=sumtotal[j].properties.CTF['FY2010-11']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2011-12'){sumtotal[j].properties.CTF['FY2011-12']=sumtotal[j].properties.CTF['FY2011-12']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2012-13'){sumtotal[j].properties.CTF['FY2012-13']=sumtotal[j].properties.CTF['FY2012-13']+Number(grants[i].totalawarded)};   
                   if(grants[i].yearofaward=='FY2013-14'){sumtotal[j].properties.CTF['FY2013-14']=sumtotal[j].properties.CTF['FY2013-14']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2014-15'){sumtotal[j].properties.CTF['FY2014-15']=sumtotal[j].properties.CTF['FY2014-15']+Number(grants[i].totalawarded)};   
                 }        
                 
                 //mini sums for EIAF
                 if(grants[i].programtype==='EIAF'){
                   if(grants[i].yearofaward=='2011'){sumtotal[j].properties.EIAF['2011']=sumtotal[j].properties.EIAF['2011']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2012'){sumtotal[j].properties.EIAF['2012']=sumtotal[j].properties.EIAF['2012']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2013'){sumtotal[j].properties.EIAF['2013']=sumtotal[j].properties.EIAF['2013']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2014'){sumtotal[j].properties.EIAF['2014']=sumtotal[j].properties.EIAF['2014']+Number(grants[i].totalawarded)};    
                   if(grants[i].yearofaward=='2015'){sumtotal[j].properties.EIAF['2015']=sumtotal[j].properties.EIAF['2015']+Number(grants[i].totalawarded)};                       
                 }    
                  
                 //mini sums for FFB
                 if(grants[i].programtype==='FFB'){
                   if(grants[i].yearofaward=='FFY2014-15'){sumtotal[j].properties.FFB['FFY2014-15']=sumtotal[j].properties.FFB['FFY2014-15']+Number(grants[i].totalawarded)};
                 }                  
                 
                 //mini sums for FML - DD
                 if(grants[i].programtype==='FML - DD'){
                   if(grants[i].yearofaward=='2009'){sumtotal[j].properties.FMLDD['2009']=sumtotal[j].properties.FMLDD['2009']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2010'){sumtotal[j].properties.FMLDD['2010']=sumtotal[j].properties.FMLDD['2010']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2011'){sumtotal[j].properties.FMLDD['2011']=sumtotal[j].properties.FMLDD['2011']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2012'){sumtotal[j].properties.FMLDD['2012']=sumtotal[j].properties.FMLDD['2012']+Number(grants[i].totalawarded)};    
                   if(grants[i].yearofaward=='2013'){sumtotal[j].properties.FMLDD['2013']=sumtotal[j].properties.FMLDD['2013']+Number(grants[i].totalawarded)};     
                   if(grants[i].yearofaward=='2014'){sumtotal[j].properties.FMLDD['2014']=sumtotal[j].properties.FMLDD['2014']+Number(grants[i].totalawarded)};                      
                 }
                 
                  //mini sums for FML - DD - SB106
                 if(grants[i].programtype==='FML - DD - SB106'){
                   if(grants[i].yearofaward=='2014'){sumtotal[j].properties.FMLDDSB106['2014']=sumtotal[j].properties.FMLDDSB106['2014']+Number(grants[i].totalawarded)};                      
                 }
                 
                 //mini sums for GAME
                 if(grants[i].programtype==='GAME'){
                   if(grants[i].yearofaward=='2010'){sumtotal[j].properties.GAME['2010']=sumtotal[j].properties.GAME['2010']+Number(grants[i].totalawarded)};                   
                   if(grants[i].yearofaward=='2011'){sumtotal[j].properties.GAME['2011']=sumtotal[j].properties.GAME['2011']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2012'){sumtotal[j].properties.GAME['2012']=sumtotal[j].properties.GAME['2012']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2013'){sumtotal[j].properties.GAME['2013']=sumtotal[j].properties.GAME['2013']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2014'){sumtotal[j].properties.GAME['2014']=sumtotal[j].properties.GAME['2014']+Number(grants[i].totalawarded)};                   
                 }
                 
                 //mini sums for REDI
                 if(grants[i].programtype==='REDI'){
                   if(grants[i].yearofaward=='2014'){sumtotal[j].properties.REDI['2014']=sumtotal[j].properties.REDI['2014']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='2015'){sumtotal[j].properties.REDI['2015']=sumtotal[j].properties.REDI['2015']+Number(grants[i].totalawarded)};                   
                 }
                 
                 //mini sums for SAR
                 if(grants[i].programtype==='SAR'){
                   if(grants[i].yearofaward=='FFY2009-10'){sumtotal[j].properties.SAR['FFY2009-10']=sumtotal[j].properties.SAR['FFY2009-10']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FFY2010-11'){sumtotal[j].properties.SAR['FFY2010-11']=sumtotal[j].properties.SAR['FFY2010-11']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FFY2011-12'){sumtotal[j].properties.SAR['FFY2011-12']=sumtotal[j].properties.SAR['FFY2011-12']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FFY2012-13'){sumtotal[j].properties.SAR['FFY2012-13']=sumtotal[j].properties.SAR['FFY2012-13']+Number(grants[i].totalawarded)};                 
                   if(grants[i].yearofaward=='FFY2013-14'){sumtotal[j].properties.SAR['FFY2013-14']=sumtotal[j].properties.SAR['FFY2013-14']+Number(grants[i].totalawarded)};                  
                 }
                 
                 //mini sums for SEVEDD
                 if(grants[i].programtype==='Seve-DD'){
                   if(grants[i].yearofaward=='FY2009'){sumtotal[j].properties.SEVEDD['FY2009']=sumtotal[j].properties.SEVEDD['FY2009']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2010'){sumtotal[j].properties.SEVEDD['FY2010']=sumtotal[j].properties.SEVEDD['FY2010']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2011'){sumtotal[j].properties.SEVEDD['FY2011']=sumtotal[j].properties.SEVEDD['FY2011']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2012'){sumtotal[j].properties.SEVEDD['FY2012']=sumtotal[j].properties.SEVEDD['FY2012']+Number(grants[i].totalawarded)};                 
                   if(grants[i].yearofaward=='FY2013'){sumtotal[j].properties.SEVEDD['FY2013']=sumtotal[j].properties.SEVEDD['FY2013']+Number(grants[i].totalawarded)};    
                   if(grants[i].yearofaward=='FY2014'){sumtotal[j].properties.SEVEDD['FY2014']=sumtotal[j].properties.SEVEDD['FY2014']+Number(grants[i].totalawarded)};                     
                 }    
                 
                 //mini sums for VFP
                 if(grants[i].programtype==='VFP'){
                   if(grants[i].yearofaward=='FY2009-10'){sumtotal[j].properties.VFP['FY2009-10']=sumtotal[j].properties.VFP['FY2009-10']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2010-11'){sumtotal[j].properties.VFP['FY2010-11']=sumtotal[j].properties.VFP['FY2010-11']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2011-12'){sumtotal[j].properties.VFP['FY2011-12']=sumtotal[j].properties.VFP['FY2011-12']+Number(grants[i].totalawarded)};
                   if(grants[i].yearofaward=='FY2012-13'){sumtotal[j].properties.VFP['FY2012-13']=sumtotal[j].properties.VFP['FY2012-13']+Number(grants[i].totalawarded)};                 
                   if(grants[i].yearofaward=='FY2013-14'){sumtotal[j].properties.VFP['FY2013-14']=sumtotal[j].properties.VFP['FY2013-14']+Number(grants[i].totalawarded)};    
                   if(grants[i].yearofaward=='FY2014-15'){sumtotal[j].properties.VFP['FY2014-15']=sumtotal[j].properties.VFP['FY2014-15']+Number(grants[i].totalawarded)};                     
                 }
                 
               } 
               
               b={'projname': grants[i].projname, 'program': grants[i].programtype, 'dateofaward': grants[i].dateofaward, 'award': grants[i].totalawarded};
               sumtotal[j].properties.projects.push(b);
             }
           }
                        
      }
        
//convert number to money format        
Number.prototype.formatMoney = function(c, d, t){
var n = this, 
    c = isNaN(c = Math.abs(c)) ? 2 : c, 
    d = d == undefined ? "." : d, 
    t = t == undefined ? "," : t, 
    s = n < 0 ? "-" : "", 
    i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
    j = (j = i.length) > 3 ? j % 3 : 0;
   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
 };
        
 //sum all values in an object
 function sum( obj ) {
  var sum = 0;
  for( var el in obj ) {
    if( obj.hasOwnProperty( el ) ) {
      sum += parseFloat( obj[el] );
    }
  }
  return sum;
}       
        
        
       
        
        
var greyIcon = L.icon({
    iconUrl: 'img/grey.png',
    //shadowUrl: 'leaf-shadow.png',
    iconSize:     [18, 16], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [16, 16], // point of the icon which will correspond to marker's location
    //shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [32, 0] // point from which the popup should open relative to the iconAnchor
});  
        
var geojsonLayer = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
        return true;
    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
}).addTo(map);
        
var stategrants = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      if((Number(sum(feature.properties.EIAF))+Number(sum(feature.properties.GAME))+Number(sum(feature.properties.REDI)))>0){return true;}else{return false;}
    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
var federalgrants = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      if((Number(sum(feature.properties.CDBG))+Number(sum(feature.properties.CSBG)))>0){return true;}else{return false;}
    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
var formulafunds = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      if((Number(sum(feature.properties.FMLDD))+Number(sum(feature.properties.FMLDDSB106))+Number(sum(feature.properties.CTF))+Number(sum(feature.properties.SEVEDD)))>0){return true;}else{return false;}
    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
var specialfunding = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      if((Number(sum(feature.properties.SAR))+Number(sum(feature.properties.VFP))+Number(sum(feature.properties.FFB)))>0){return true;}else{return false;}
    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
                
 var groupedOverlays = {
  "Grants": {
    "All": geojsonLayer
    ,"State Grants": stategrants
     ,"Federal Grants": federalgrants
     ,"Formula Funds": formulafunds
     ,"Special Funding": specialfunding
  },
     "Geo": {
    "Cities": []
    ,"Counties": []
     ,"Districts": []
  }
};

var options = { exclusiveGroups: ["Grants"] };

L.control.groupedLayers(null, groupedOverlays, options).addTo(map);       
   
        
        console.log(sumtotal);
        
      });
    </script>
  </body>
</html>