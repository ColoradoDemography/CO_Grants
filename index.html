<html>
  <body>

     <link rel="stylesheet" href="jquery/jquery-ui.min.css" />    
     <link rel="stylesheet" href="jquery/jquery-ui.structure.min.css" />        
     <link rel="stylesheet" href="jquery/jquery-ui.theme.min.css" />     
     <link rel="stylesheet" href="css/classic-min.css" />  
    
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet.groupedlayercontrol.css" />
    <link rel="stylesheet" href="css/MarkerCluster.Default.css" />    
   


    
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="jquery/jquery-ui.min.js"></script>
    <script src="js/jQDateRangeSlider-min.js"></script>     
    
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="js/leaflet.groupedlayercontrol.min.js"></script>
    <script src="js/leaflet.markercluster.js"></script> 


    
    <script type="text/javascript" src="data/convertcsv.json"></script>
    <script type="text/javascript" src="data/stratfunding.json"></script>
    
    <div id="map"></div>

<article style="position: absolute; top:40px; left:5%; width: 90%;">
    <div id="slider"></div></article>
    
    
    <style>
      #map {
        width: 100%;
        height: 100%;
      }

    </style>
    



    <!-- Okay, time to do this! -->
    <script type="text/javascript">
      $(document).ready( function() {
        
        
var mindate=new Date("Thu Jan 01 2014 00:00:00 GMT-0700");
var maxdate=new Date("Thu Jan 01 2016 00:00:00 GMT-0700");
        
        var city_federal, county_federal, district_federal, city_state, county_state, district_state, city_formula, county_formula, district_formula, city_special, county_special, district_special;
        
        
        var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ';

	    var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
		    streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});
        
		var map = L.map('map', {
    center: [39, -105.5],
    zoom: 7,
    minZoom: 6,
    maxZoom: 13, 
			layers: [grayscale]
		});


        
        //function that will reduce an array to unique values
    var arrayUnique = function(a) {
      return a.reduce(function(p, c) {
        if (p.indexOf(c) < 0) p.push(c);
        return p;
        }, []);
    };
      
        //list of all lgid's in main grants json file
        var lgidlist=[]; //array of strings
        var sumtotal=[]; //array of objects
        
        var i,j;  //iterators
        
        var b={}; //temp objects
        var gjson={};
        
        for(i=0;i<grants.length;i=i+1){
          if(grants[i].lgid){lgidlist.push(grants[i].lgid);}
        }
        
        //reduce to unique values only
        lgidlist = arrayUnique(lgidlist);
        
        //join to x, y, govname
        for(i=0;i<lgidlist.length;i=i+1){
          for(j=0;j<xy.length;j=j+1){
            if(lgidlist[i]==xy[j].LG_ID){
              var coordx=xy[j].X;
              var coordy=xy[j].Y;
              if(!coordx){coordx=0;coordy=0;}
              var geom={'type': 'Point', 'coordinates':[coordy, coordx]};
              
              


              
              var state={'eiaf': [], 'game': [], 'redi': [] };
              var federal={'cdbg': [], 'csbg': [] };
              var formula={'fmldd': [], 'fmlddsb106': [], 'ctf': [], 'sevedd': [] };
              var special={'ffb': [], 'sar': [], 'vfp': [] };
              
              var projects={'state': state, 'federal': federal, 'formula': formula, 'special': special};
              
              b={'lgid': lgidlist[i], 'lgtype': xy[j].LGTYPE_ID, 'govname': xy[j].NAME, 'x': xy[j].X, 'y': xy[j].Y, 'total': 0, 'projects': projects };              
              gjson={'type': 'Feature', 'geometry': geom, 'properties': b};
              if(coordx){sumtotal.push(gjson);}else{
                //console.log(xy[j].LG_ID);
              } //remove
            }
          }
        }
        
        //loop through all projects.  add to sumtotal.  add to projects{}
         for(i=0;i<grants.length;i=i+1){
           for(j=0;j<sumtotal.length;j=j+1){
             if(grants[i].lgid===sumtotal[j].properties.lgid){
               if(grants[i].totalawarded){
                 
                 sumtotal[j].properties.total=sumtotal[j].properties.total+Number(grants[i].totalawarded); //if totalawarded exists, add it to lgidsumaward
                 
                b={'projname': grants[i].projname, 'program': grants[i].programtype, 'dateofaward': grants[i].dateofaward, 'yearofaward': grants[i].yearofaward,  'award': grants[i].totalawarded};

                 
                 //mini sums for CDBG
                 if(grants[i].programtype==='CDBG'){
                   sumtotal[j].properties.projects.federal.cdbg.push(b);
                 }
                 
                 //mini sums for CSBG
                 if(grants[i].programtype==='CSBG'){
                   sumtotal[j].properties.projects.federal.csbg.push(b);
                 }
                 
                 //mini sums for CTF
                 if(grants[i].programtype==='CTF'){
                   sumtotal[j].properties.projects.formula.ctf.push(b);
                 }        
                 
                 //mini sums for EIAF
                 if(grants[i].programtype==='EIAF'){
                   sumtotal[j].properties.projects.state.eiaf.push(b);                     
                 }    
                  
                 //mini sums for FFB
                 if(grants[i].programtype==='FFB'){
                   sumtotal[j].properties.projects.special.ffb.push(b);
                 }                  
                 
                 //mini sums for FML - DD
                 if(grants[i].programtype==='FML - DD'){
                   sumtotal[j].properties.projects.formula.fmldd.push(b);
                 }
                 
                  //mini sums for FML - DD - SB106
                 if(grants[i].programtype==='FML - DD - SB106'){
                   sumtotal[j].properties.projects.formula.fmlddsb106.push(b);
                 }
                 
                 //mini sums for GAME
                 if(grants[i].programtype==='GAME'){
                   sumtotal[j].properties.projects.state.game.push(b);
                 }
                 
                 //mini sums for REDI
                 if(grants[i].programtype==='REDI'){
                   sumtotal[j].properties.projects.state.redi.push(b);
                 }
                 
                 //mini sums for SAR
                 if(grants[i].programtype==='SAR'){
                   sumtotal[j].properties.projects.special.sar.push(b);
                 }
                 
                 //mini sums for SEVEDD
                 if(grants[i].programtype==='Seve-DD'){
                   sumtotal[j].properties.projects.formula.sevedd.push(b);
                 }    
                 
                 //mini sums for VFP
                 if(grants[i].programtype==='VFP'){
                   sumtotal[j].properties.projects.special.vfp.push(b);
                 }
                 
               } 
               

             }
           }
                        
      }
        
//convert number to money format        
Number.prototype.formatMoney = function(c, d, t){
var n = this, 
    c = isNaN(c = Math.abs(c)) ? 2 : c, 
    d = d == undefined ? "." : d, 
    t = t == undefined ? "," : t, 
    s = n < 0 ? "-" : "", 
    i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
    j = (j = i.length) > 3 ? j % 3 : 0;
   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
 };
        
 //sum all values in an object
 function sum( obj ) {
  var sum = 0;
  for( var el in obj ) {
    if( obj.hasOwnProperty( el ) ) {
      sum += parseFloat( obj[el] );
    }
  }
  return sum;
}       
        
var greyIcon = L.icon({
    iconUrl: 'img/grey.png',
    //shadowUrl: 'leaf-shadow.png',
    iconSize:     [18, 16], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [16, 16], // point of the icon which will correspond to marker's location
    //shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [32, 0] // point from which the popup should open relative to the iconAnchor
});  
        
        
        
function refreshdata(){        
//geojsonLayer
 city_federal = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var cdbgexist=(feature.properties.projects.federal.cdbg).length;
      var csbgexist=(feature.properties.projects.federal.csbg).length;
      if((cdbgexist+csbgexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(cdbgexist>0){
        for(i=0;i<cdbgexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.federal.cdbg[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(csbgexist>0){
        for(i=0;i<csbgexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.federal.csbg[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(countprojinrange===0){return false;}
      
      //filter by geography
      if(feature.properties.lgtype==2 || feature.properties.lgtype==3 || feature.properties.lgtype==4 || feature.properties.lgtype==5 ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
 county_federal = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var cdbgexist=(feature.properties.projects.federal.cdbg).length;
      var csbgexist=(feature.properties.projects.federal.csbg).length;
      if((cdbgexist+csbgexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(cdbgexist>0){
        for(i=0;i<cdbgexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.federal.cdbg[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(csbgexist>0){
        for(i=0;i<csbgexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.federal.csbg[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(countprojinrange===0){return false;}
      
      //filter by geography
      if(feature.properties.lgtype==1 || feature.properties.lgtype==61 || feature.properties.lgtype==70  ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});     
        
        
 district_federal = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var cdbgexist=(feature.properties.projects.federal.cdbg).length;
      var csbgexist=(feature.properties.projects.federal.csbg).length;
      if((cdbgexist+csbgexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(cdbgexist>0){
        for(i=0;i<cdbgexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.federal.cdbg[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(csbgexist>0){
        for(i=0;i<csbgexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.federal.csbg[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(countprojinrange===0){return false;}
      
      //filter by geography
      if(feature.properties.lgtype!==1 && feature.properties.lgtype!==61 && feature.properties.lgtype!==70 && feature.properties.lgtype!==2 && feature.properties.lgtype!==3 && feature.properties.lgtype!==4 && feature.properties.lgtype!==5){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});            
      
        
        
//geojsonLayer
 city_state = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var eiafexist=(feature.properties.projects.state.eiaf).length;
      var gameexist=(feature.properties.projects.state.game).length;
      var rediexist=(feature.properties.projects.state.redi).length;      
      if((eiafexist+gameexist+rediexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(eiafexist>0){
        for(i=0;i<eiafexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.eiaf[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(gameexist>0){
        for(i=0;i<gameexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.game[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(rediexist>0){
        for(i=0;i<rediexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.redi[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(countprojinrange===0){return false;}
      
      //filter by geography
      if(feature.properties.lgtype==2 || feature.properties.lgtype==3 || feature.properties.lgtype==4 || feature.properties.lgtype==5 ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
 county_state = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var eiafexist=(feature.properties.projects.state.eiaf).length;
      var gameexist=(feature.properties.projects.state.game).length;
      var rediexist=(feature.properties.projects.state.redi).length;      
      if((eiafexist+gameexist+rediexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(eiafexist>0){
        for(i=0;i<eiafexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.eiaf[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(gameexist>0){
        for(i=0;i<gameexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.game[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(rediexist>0){
        for(i=0;i<rediexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.redi[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(countprojinrange===0){return false;}
            
      if(feature.properties.lgtype==1 || feature.properties.lgtype==61 || feature.properties.lgtype==70  ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});     
        
        
 district_state = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var eiafexist=(feature.properties.projects.state.eiaf).length;
      var gameexist=(feature.properties.projects.state.game).length;
      var rediexist=(feature.properties.projects.state.redi).length;      
      if((eiafexist+gameexist+rediexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(eiafexist>0){
        for(i=0;i<eiafexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.eiaf[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(gameexist>0){
        for(i=0;i<gameexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.game[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(rediexist>0){
        for(i=0;i<rediexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.state.redi[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(countprojinrange===0){return false;}
            
      if(feature.properties.lgtype!==1 && feature.properties.lgtype!==61 && feature.properties.lgtype!==70 && feature.properties.lgtype!==2 && feature.properties.lgtype!==3 && feature.properties.lgtype!==4 && feature.properties.lgtype!==5){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});            
              
//geojsonLayer
 city_formula = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var ctfexist=(feature.properties.projects.formula.ctf).length;
      var fmlddexist=(feature.properties.projects.formula.fmldd).length;
      var fmlddsb106exist=(feature.properties.projects.formula.fmlddsb106).length;      
      var sevedd=(feature.properties.projects.formula.sevedd).length;            
      if((ctfexist+fmlddexist+fmlddsb106exist+sevedd)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(ctfexist>0){
        for(i=0;i<ctfexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.ctf[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(fmlddexist>0){
        for(i=0;i<fmlddexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.fmldd[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(fmlddsb106exist>0){
        for(i=0;i<fmlddsb106exist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.fmlddsb106[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(sevedd>0){
        for(i=0;i<sevedd;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.sevedd[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }            
      if(countprojinrange===0){return false;}
            
      if(feature.properties.lgtype==2 || feature.properties.lgtype==3 || feature.properties.lgtype==4 || feature.properties.lgtype==5 ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
 county_formula = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var ctfexist=(feature.properties.projects.formula.ctf).length;
      var fmlddexist=(feature.properties.projects.formula.fmldd).length;
      var fmlddsb106exist=(feature.properties.projects.formula.fmlddsb106).length;      
      var sevedd=(feature.properties.projects.formula.sevedd).length;            
      if((ctfexist+fmlddexist+fmlddsb106exist+sevedd)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(ctfexist>0){
        for(i=0;i<ctfexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.ctf[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(fmlddexist>0){
        for(i=0;i<fmlddexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.fmldd[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(fmlddsb106exist>0){
        for(i=0;i<fmlddsb106exist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.fmlddsb106[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(sevedd>0){
        for(i=0;i<sevedd;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.sevedd[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }            
      if(countprojinrange===0){return false;}
                  
      if(feature.properties.lgtype==1 || feature.properties.lgtype==61 || feature.properties.lgtype==70  ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});     
        
        
 district_formula = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var ctfexist=(feature.properties.projects.formula.ctf).length;
      var fmlddexist=(feature.properties.projects.formula.fmldd).length;
      var fmlddsb106exist=(feature.properties.projects.formula.fmlddsb106).length;      
      var sevedd=(feature.properties.projects.formula.sevedd).length;            
      if((ctfexist+fmlddexist+fmlddsb106exist+sevedd)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(ctfexist>0){
        for(i=0;i<ctfexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.ctf[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(fmlddexist>0){
        for(i=0;i<fmlddexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.fmldd[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(fmlddsb106exist>0){
        for(i=0;i<fmlddsb106exist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.fmlddsb106[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(sevedd>0){
        for(i=0;i<sevedd;i=i+1){
          var dateofproj = new Date(feature.properties.projects.formula.sevedd[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }            
      if(countprojinrange===0){return false;}
            
      if(feature.properties.lgtype!==1 && feature.properties.lgtype!==61 && feature.properties.lgtype!==70 && feature.properties.lgtype!==2 && feature.properties.lgtype!==3 && feature.properties.lgtype!==4 && feature.properties.lgtype!==5){return true;}else{return false;}
  
    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});            

//geojsonLayer
 city_special = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var ffbexist=(feature.properties.projects.special.ffb).length;
      var sarexist=(feature.properties.projects.special.sar).length;
      var vfpexist=(feature.properties.projects.special.vfp).length;      
      if((ffbexist+sarexist+vfpexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(ffbexist>0){
        for(i=0;i<ffbexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.ffb[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(sarexist>0){
        for(i=0;i<sarexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.sar[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(vfpexist>0){
        for(i=0;i<vfpexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.vfp[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(countprojinrange===0){return false;}
                  
      if(feature.properties.lgtype==2 || feature.properties.lgtype==3 || feature.properties.lgtype==4 || feature.properties.lgtype==5 ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});
        
 county_special = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var ffbexist=(feature.properties.projects.special.ffb).length;
      var sarexist=(feature.properties.projects.special.sar).length;
      var vfpexist=(feature.properties.projects.special.vfp).length;      
      if((ffbexist+sarexist+vfpexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(ffbexist>0){
        for(i=0;i<ffbexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.ffb[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(sarexist>0){
        for(i=0;i<sarexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.sar[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(vfpexist>0){
        for(i=0;i<vfpexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.vfp[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(countprojinrange===0){return false;}
                 
      if(feature.properties.lgtype==1 || feature.properties.lgtype==61 || feature.properties.lgtype==70  ){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" +
          "CSBG: $" + csbg.formatMoney(0) +"</br>" +
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});     
        
        
 district_special = L.geoJson(sumtotal, {
    filter: function(feature, layer) {
      
      //filter out if no projects
      var ffbexist=(feature.properties.projects.special.ffb).length;
      var sarexist=(feature.properties.projects.special.sar).length;
      var vfpexist=(feature.properties.projects.special.vfp).length;      
      if((ffbexist+sarexist+vfpexist)==0){return false;}
      
      //filter out if no projects in date range
      var countprojinrange=0;
      if(ffbexist>0){
        for(i=0;i<ffbexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.ffb[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(sarexist>0){
        for(i=0;i<sarexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.sar[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }
      if(vfpexist>0){
        for(i=0;i<vfpexist;i=i+1){
          var dateofproj = new Date(feature.properties.projects.special.vfp[i].dateofaward);
          if(dateofproj>mindate && dateofproj<maxdate){countprojinrange=countprojinrange+1;}
            }
      }      
      if(countprojinrange===0){return false;}
                 
      if(feature.properties.lgtype!==1 && feature.properties.lgtype!==61 && feature.properties.lgtype!==70 && feature.properties.lgtype!==2 && feature.properties.lgtype!==3 && feature.properties.lgtype!==4 && feature.properties.lgtype!==5){return true;}else{return false;}

    },
//     style: function(feature) {
//         return {color: 'green'};
//     },
    pointToLayer: function(feature, latlng) {
        return new L.Marker(latlng, {icon: greyIcon});
    },
    onEachFeature: function (feature, layer) {
      var yearstart='start';  //get these from date slider eventually
      var yearend='end';
      
      var csbg=sum(feature.properties.CSBG);
      var ctf=sum(feature.properties.CTF);
      
      var popuphtml=feature.properties.govname + "<br />" + 
          yearstart + "-" + yearend +"</br>" + 
          "Total Awarded: $" + (feature.properties.total).formatMoney(0)  +"</br>" + 
          "CSBG: $" + csbg.formatMoney(0) +"</br>" + 
          "CTF: $" + ctf.formatMoney(0) +"</br>" ;
      
        layer.bindPopup(popuphtml);
    }
});            

};
        
        
        
        refreshdata();
        
//  var groupedOverlays = {
//   "Grants": {
//     "All": geojsonLayer
//     ,"State Grants": stategrants
//      ,"Federal Grants": federalgrants
//      ,"Formula Funds": formulafunds
//      ,"Special Funding": specialfunding
//   },
//      "Geo": {
//     "Cities": []
//     ,"Counties": []
//      ,"Districts": []
//   }
// };

// var options = { exclusiveGroups: ["Grants"] };

// L.control.groupedLayers(null, groupedOverlays, options).addTo(map);       
   
        
        //addLayer, removeLayer and clearLayers are supported and they should work for most uses.
        
        console.log(sumtotal);
        
        var markers = new L.MarkerClusterGroup();
        
        markers.addLayer(city_federal);    
        markers.addLayer(county_federal); 
        markers.addLayer(district_federal);         
        markers.addLayer(city_state);    
        markers.addLayer(county_state); 
        markers.addLayer(district_state);   
        markers.addLayer(city_formula);    
        markers.addLayer(county_formula); 
        markers.addLayer(district_formula);   
        markers.addLayer(city_special);    
        markers.addLayer(county_special); 
        markers.addLayer(district_special);   
        
        map.addLayer(markers);




     $("#slider").dateRangeSlider({
  bounds:{
    min: new Date("Thu Jan 01 2010 00:00:00 GMT-0700"),
    max: maxdate
  },
       defaultValues:{
    min: mindate,
    max: maxdate
  }
     
     });
        
$("#slider").bind("valuesChanged", function(e, data){
  mindate = data.values.min;
  maxdate = data.values.max;
  
    markers.clearLayers();
   
  refreshdata();
   
        markers.addLayer(city_federal);    
        markers.addLayer(county_federal); 
        markers.addLayer(district_federal);         
        markers.addLayer(city_state);    
        markers.addLayer(county_state); 
        markers.addLayer(district_state);   
        markers.addLayer(city_formula);    
        markers.addLayer(county_formula); 
        markers.addLayer(district_formula);   
        markers.addLayer(city_special);    
        markers.addLayer(county_special); 
        markers.addLayer(district_special);   
   
  map.addLayer(markers); 
  
});
        
      });
    </script>
  </body>
</html>