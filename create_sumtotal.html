<html>
  <head>
    <title>Crunch JSON</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    
    <script type="text/javascript" src="data/convertcsv.json"></script>
    <script type="text/javascript" src="data/stratfunding.json"></script>

    
    <script>
      
//sum all values in an object
 function sum( obj ) {
  var sum = 0;
  for( var el in obj ) {
    if( obj.hasOwnProperty( el ) ) {
      sum += parseFloat( obj[el] );
    }
  }
  return sum;
}       

        //function that will reduce an array to unique values
    var arrayUnique = function(a) {
      return a.reduce(function(p, c) {
        if (p.indexOf(c) < 0) p.push(c);
        return p;
        }, []);
    };
      
        //list of all lgid's in main grants json file
        var lgidlist=[]; //array of strings
        var sumtotal=[]; //array of objects
        
        var i,j;  //iterators
        
        var b={}; //temp objects
        var gjson={};
        
        for(i=0;i<grants.length;i=i+1){
          if(grants[i].lgid){lgidlist.push(grants[i].lgid);}
        }
        
        //reduce to unique values only
        lgidlist = arrayUnique(lgidlist);
        
        //join to x, y, govname
        for(i=0;i<lgidlist.length;i=i+1){
          for(j=0;j<xy.length;j=j+1){
            if(lgidlist[i]==xy[j].LG_ID){
              var coordx=xy[j].X;
              var coordy=xy[j].Y;
              if(!coordx){coordx=0;coordy=0;}
              var geom={'type': 'Point', 'coordinates':[coordy, coordx]};
              
              


              
              var state={'eiaf': [], 'game': [], 'redi': [] };
              var federal={'cdbg': [], 'csbg': [] };
              var formula={'fmldd': [], 'fmlddsb106': [], 'ctf': [], 'sevedd': [] };
              var special={'ffb': [], 'sar': [], 'vfp': [] };
              
              var projects={'state': state, 'federal': federal, 'formula': formula, 'special': special};
              
              b={'lgid': lgidlist[i], 'lgtype': xy[j].LGTYPE_ID, 'govname': xy[j].NAME, 'x': xy[j].X, 'y': xy[j].Y, 'total': 0, 'projects': projects };              
              gjson={'type': 'Feature', 'geometry': geom, 'properties': b};
              if(coordx){sumtotal.push(gjson);}else{
                //console.log(xy[j].LG_ID);
              } //remove
            }
          }
        }
        
        //loop through all projects.  add to sumtotal.  add to projects{}
         for(i=0;i<grants.length;i=i+1){
           for(j=0;j<sumtotal.length;j=j+1){
             if(grants[i].lgid===sumtotal[j].properties.lgid){
               if(grants[i].totalawarded){
                 
                 sumtotal[j].properties.total=sumtotal[j].properties.total+Number(grants[i].totalawarded); //if totalawarded exists, add it to lgidsumaward
                 
                b={'projname': grants[i].projname, 'program': grants[i].programtype, 'dateofaward': grants[i].dateofaward, 'yearofaward': grants[i].yearofaward,  'award': grants[i].totalawarded};

                 
                 //mini sums for CDBG
                 if(grants[i].programtype==='CDBG'){
                   sumtotal[j].properties.projects.federal.cdbg.push(b);
                 }
                 
                 //mini sums for CSBG
                 if(grants[i].programtype==='CSBG'){
                   sumtotal[j].properties.projects.federal.csbg.push(b);
                 }
                 
                 //mini sums for CTF
                 if(grants[i].programtype==='CTF'){
                   sumtotal[j].properties.projects.formula.ctf.push(b);
                 }        
                 
                 //mini sums for EIAF
                 if(grants[i].programtype==='EIAF'){
                   sumtotal[j].properties.projects.state.eiaf.push(b);                     
                 }    
                  
                 //mini sums for FFB
                 if(grants[i].programtype==='FFB'){
                   sumtotal[j].properties.projects.special.ffb.push(b);
                 }                  
                 
                 //mini sums for FML - DD
                 if(grants[i].programtype==='FML - DD'){
                   sumtotal[j].properties.projects.formula.fmldd.push(b);
                 }
                 
                  //mini sums for FML - DD - SB106
                 if(grants[i].programtype==='FML - DD - SB106'){
                   sumtotal[j].properties.projects.formula.fmlddsb106.push(b);
                 }
                 
                 //mini sums for GAME
                 if(grants[i].programtype==='GAME'){
                   sumtotal[j].properties.projects.state.game.push(b);
                 }
                 
                 //mini sums for REDI
                 if(grants[i].programtype==='REDI'){
                   sumtotal[j].properties.projects.state.redi.push(b);
                 }
                 
                 //mini sums for SAR
                 if(grants[i].programtype==='SAR'){
                   sumtotal[j].properties.projects.special.sar.push(b);
                 }
                 
                 //mini sums for SEVEDD
                 if(grants[i].programtype==='Seve-DD'){
                   sumtotal[j].properties.projects.formula.sevedd.push(b);
                 }    
                 
                 //mini sums for VFP
                 if(grants[i].programtype==='VFP'){
                   sumtotal[j].properties.projects.special.vfp.push(b);
                 }
                 
               } 
               

             }
           }
                        
      }
        

        var js_objectstring=JSON.stringify(sumtotal);
        

        
            $.ajax({
        type: "POST",
        url: "create_json.php",
        data: "jsobj="+encodeURIComponent(js_objectstring),
        dataType: 'text'
    });
        
      </script>    
    
  </head>
  <body>

  </body>
</html> 

